# go-complexity-analysis

go-complexity-analysis calculates:
* the Cyclomatic complexities
* the Halstead complexities (difficulty and volume)
* the Maintainability indices
* lines of code
  of golang functions.

Additionally it counts package imports from same application. This is indicator of how interconnected application packages are with each other. Higher number suggests more interconnections and lower code refactoring capability.

# Install

```sh
$ go get github.com/fikin/go-complexity-analysis/cmd/complexity
```

# Usage

```sh
$ go vet -vettool=$(which complexity) [flags] [directory/file]
```

## Flags

`--cycloover`: show functions with the Cyclomatic complexity > N (default: 10)

`--maintunder`: show functions with the Maintainability index < N (default: 20)

`--maxlines`: show functions with lines of code (excluding constants) index < N (default: 50)

`--csv`: print function stats in csv format

`--allstats`: print stats for all functions, even ok ones

## Output

```
<filename>:<line>:<column>: func <funcname> seems to be complex (cyclomatic complexity=<cyclomatic complexity>)
<filename>:<line>:<column>: func <funcname> seems to have low maintainability (maintainability index=<maintainability index>)
<pkgname>,<functions count>,-1,total,<cyclomatic complexity>,<maintainability index>,<halstead difficulty>,<halstead volume>,<loc>,<constLoc>,<fileIsGenerated>,<tooComplex>,<notMaintenable>,<tooManyLines>
```

## Examples

```go
$ go vet -vettool=$(which complexity) --cycloover 10 ./...
$ go vet -vettool=$(which complexity) --maintunder 20 main.go
$ go vet -vettool=$(which complexity) --cycloover 5 --maintunder 30 ./src
$ go vet -vettool=$(which complexity) --maxlines 30 ./src
$ go vet -vettool=$(which complexity) --csv --allstats ./src
```

## Github Actions

You can use the Github Actions to execute the complexity command on Github pull requests with [reviewdog](https://github.com/reviewdog/reviewdog).

See [fikin/go-complexity-analysis-action](https://github.com/fikin/go-complexity-analysis-action) for the details.


# Metrics

## Cyclomatic Complexity

The Cyclomatic complexity indicates the complexity of a program.

This program calculates the complexities of each function by counting idependent paths with the following rules.
```
Initial value: 1
+1: if, for, case, ||, &&
```

## Halstead Metrics

Calculation of each Halstead metrics can be found [here](https://www.verifysoft.com/en_halstead_metrics.html).

### Rules

1. Comments are not considered in Halstead Metrics
2. Operands and Operators are divided as follows:

#### Operands

- [Identifiers](!https://golang.org/ref/spec#Identifiers)
- [Constants](!https://golang.org/ref/spec#Constants)
- [Variables](!https://golang.org/ref/spec#Variables)

#### Operators
- [Operators](!https://golang.org/ref/spec#Operators_and_punctuation)
    - Parenthesis, such as "()", is counted as one operator
- [Keywords](!https://golang.org/ref/spec#Keywords)

## Maintainability Index

The Maintainability index represents maintainability of a program.

The value is calculated with the Cyclomatic complexity and the Halstead volume by using the following formula.
```
Maintainability Index = 171 - 5.2 * ln(Halstead Volume) - 0.23 * (Cyclomatic Complexity) - 16.2 * ln(Lines of Code)
```

This program shows normalized values instead of the original ones [introduced by Microsoft](https://docs.microsoft.com/en-us/archive/blogs/codeanalysis/maintainability-index-range-and-meaning).
```
Normalized Maintainability Index = MAX(0,(171 - 5.2 * ln(Halstead Volume) - 0.23 * (Cyclomatic Complexity) - 16.2 * ln(Lines of Code))*100 / 171)
```

The thresholds are as follows:
```
0-9 = Red
10-19 = Yellow
20-100 = Green
```

## Too many lines of code

This check is calculating function's lines of code, excluding lines for constants.

## CSV export

The analyzer can print data in csv format in order to offer easy import into other tools.

## Excluding individual functions 

The analyzer is recognizing following function comment:
```
//complexity:ignore
func ...
```

If provided, the function is excluded from the checks.

## Working with generated files

The analyzer is recognizing following file comment:
```
// Code generated by ABC. DO NOT EDIT.
...
```

If such comment is present, the entire file is excluded from the checks.
